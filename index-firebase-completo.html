<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Evaluación - Tendones Flexores</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase App (core) SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
    <!-- Firebase Firestore SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>
    
    <script>
        // Tu configuración de Firebase
        const firebaseConfig = {
            apiKey: "AZaSyDwTNxMSny7QtJNL6sYbEqbUwqRPITRSzE",
            authDomain: "lesion-de-flexores-un.firebaseapp.com",
            projectId: "lesion-de-flexores-un",
            storageBucket: "lesion-de-flexores-un.appspot.com",
            messagingSenderId: "401340786156",
            appId: "1:401340786156:web:0a9a704001e4b8875d0cc9",
            measurementId: "G-523XECBC8H"
        };

        // Inicialización
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        console.log('Firebase inicializado correctamente');
    </script>
    
    <style>
        /* Corrección de márgenes más amplios */
        .container {
            max-width: 1400px !important;
            margin: 0 auto;
            padding: 20px 40px !important;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)) !important;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .col-span-2 {
            grid-column: span 2;
        }
        
        /* Mejora de goniometría */
        .goniometry-grid {
            display: grid;
            grid-template-columns: 150px repeat(3, 120px);
            gap: 8px;
            max-width: 600px;
            margin: 20px 0;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
        }
        
        .gonio-header {
            background: #2c5aa0;
            color: white;
            padding: 10px 8px;
            text-align: center;
            font-weight: bold;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .gonio-label {
            background: #e8f2ff;
            padding: 10px 8px;
            text-align: center;
            font-weight: 500;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .gonio-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
            max-width: 100%;
        }
        
        .gonio-input:focus {
            border-color: #2c5aa0;
            outline: none;
            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.2);
        }
        
        /* Estilo para botones de edición */
        .edit-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin: 2px;
        }
        
        .edit-button:hover {
            background: #218838;
        }
        
        /* Mejores espacios en las tarjetas */
        .card {
            margin-bottom: 25px !important;
            padding: 25px !important;
        }
        
        .card-body {
            padding: 20px 0 !important;
        }
        
        /* Espaciado mejorado para secciones clínicas */
        .clinical-history-item {
            margin-bottom: 20px;
            padding: 20px;
        }
        
        .clinical-data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        /* Estilos para modales de edición */
        .edit-modal {
            max-width: 900px;
            width: 90vw;
        }
        
        .edit-followups-container {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .edit-followup-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        
        .edit-followup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .edit-followup-summary {
            font-size: 14px;
            color: #666;
        }
        
        .edit-followup-summary p {
            margin: 5px 0;
        }
        
        .add-followup-section {
            text-align: center;
            padding: 20px;
            border-top: 1px solid #ddd;
        }
        
        /* Firebase status indicator */
        .firebase-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .firebase-status.error {
            background: #f44336;
        }
        
        /* Alert styles */
        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
            position: relative;
        }
        
        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f1b0b7;
        }
        
        .alert.info {
            background: #cce7ff;
            color: #004d80;
            border: 1px solid #99d6ff;
        }
        
        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffe4a3;
        }
        
        /* Responsividad mejorada */
        @media (max-width: 768px) {
            .container {
                padding: 15px 20px !important;
            }
            
            .goniometry-grid {
                grid-template-columns: 120px repeat(3, 100px);
                gap: 6px;
            }
            
            .form-grid {
                grid-template-columns: 1fr !important;
            }
            
            .edit-modal {
                width: 95vw;
                max-width: 95vw;
            }
            
            .edit-followup-header {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase status indicator -->
    <div id="firebaseStatus" class="firebase-status">🔥 Conectado a Firebase</div>
    
    <div class="container">
        
        <!-- Pantalla de Acceso Inicial -->
        <section id="accessScreen" class="section active">
            <div class="access-screen">
                <div class="app-header">
                    <h1>Sistema de Evaluación - Tendones Flexores</h1>
                    <p>Seguimiento de pacientes con lesiones en zonas I, II, III, IV y V</p>
                    <p><small>🔥 <strong>Datos guardados en la nube con Firebase</strong></small></p>
                </div>
                
                <div class="access-buttons">
                    <button class="btn btn--primary" onclick="showSection('patientSection')">
                        Acceso Paciente
                    </button>
                    <button class="btn btn--secondary" onclick="showSection('doctorLogin')">
                        Acceso Médico
                    </button>
                </div>
            </div>
        </section>

        <!-- Login Médico -->
        <section id="doctorLogin" class="section">
            <div class="login-container">
                <div class="card">
                    <div class="card-header">
                        <h2>Acceso Médico</h2>
                        <p><small>🔥 Los datos se sincronizan automáticamente en la nube</small></p>
                    </div>
                    <div class="card-body">
                        <form id="doctorLoginForm">
                            <div class="form-group">
                                <label class="form-label">Número de Cédula</label>
                                <input type="text" id="doctorId" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nombre Completo</label>
                                <input type="text" id="doctorName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contraseña</label>
                                <input type="password" id="doctorPassword" class="form-control" required>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn--primary">Ingresar</button>
                                <button type="button" class="btn btn--outline" onclick="showSection('accessScreen')">Volver</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sección Paciente -->
        <section id="patientSection" class="section">
            <div class="section-header">
                <h2>Información para Pacientes</h2>
                <button class="btn btn--outline" onclick="showSection('accessScreen')">Volver</button>
            </div>
            
            <!-- Protocolos de Ejercicios -->
            <div class="card">
                <div class="card-header">
                    <h3>Protocolos de Ejercicios</h3>
                </div>
                <div class="card-body">
                    <div class="protocol-tabs">
                        <button class="tab-button active" onclick="showProtocol('KLEINERT')">KLEINERT</button>
                        <button class="tab-button" onclick="showProtocol('DURAN')">DURAN</button>
                        <button class="tab-button" onclick="showProtocol('ACTIVE_MOTION')">ACTIVE MOTION</button>
                    </div>
                    <div id="protocolContent" class="protocol-content">
                        <!-- Se llena dinámicamente -->
                    </div>
                </div>
            </div>

            <!-- Cuidados del Paciente -->
            <div class="card">
                <div class="card-header">
                    <h3>Cuidados del Paciente</h3>
                </div>
                <div class="card-body">
                    <div class="care-section">
                        <h4>Cuidados de Férula y Cicatriz</h4>
                        
                        <div class="care-subsection">
                            <h5>Cuidado de la Férula</h5>
                            <ul class="care-list">
                                <li>Mantener seca y limpia</li>
                                <li>No remover sin indicación médica</li>
                                <li>Revisar ajuste diariamente</li>
                                <li>Reportar dolor, hinchazón o cambios de color</li>
                                <li>No mojarse durante el baño</li>
                            </ul>
                        </div>
                        
                        <div class="care-subsection">
                            <h5>Cuidado de la Cicatriz</h5>
                            <ul class="care-list">
                                <li>Mantener área limpia y seca</li>
                                <li>Masaje cicatricial posterior a 3 semanas</li>
                                <li>Protección solar durante 6 meses</li>
                                <li>Aplicar crema hidratante suave</li>
                                <li>Evitar exposición a productos químicos</li>
                            </ul>
                        </div>
                        
                        <div class="care-subsection">
                            <h5>Signos de Alerta</h5>
                            <ul class="care-list">
                                <li>Aumento del dolor o inflamación</li>
                                <li>Enrojecimiento o calor en la herida</li>
                                <li>Secreción con mal olor</li>
                                <li>Fiebre mayor a 38°C</li>
                                <li>Pérdida súbita de movimiento</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dashboard Médico -->
        <section id="dashboard" class="section">
            <div id="doctorInfo" class="doctor-info">
                <!-- Se llena dinámicamente -->
            </div>
            
            <header class="app-header">
                <h1>Sistema de Evaluación - Tendones Flexores</h1>
                <p>Panel de Control Médico</p>
                <p><small>🔥 <strong>Datos sincronizados en Firebase</strong> - Compartidos entre todos los usuarios</small></p>
            </header>

            <div class="dashboard-stats">
                <div class="card stat-card">
                    <div class="card-body">
                        <h3>Total Pacientes</h3>
                        <div class="stat-number" id="totalPacientes">0</div>
                    </div>
                </div>
                
                <div class="card stat-card">
                    <div class="card-body">
                        <h3>Controles Pendientes</h3>
                        <div class="stat-number" id="controlesPendientes">0</div>
                    </div>
                </div>
                
                <div class="card stat-card">
                    <div class="card-body">
                        <h3>Pacientes con Controles Incompletos</h3>
                        <div class="stat-number" id="pacientesIncompletos">0</div>
                    </div>
                </div>
            </div>

            <div class="search-section">
                <h3>Búsqueda de Pacientes</h3>
                <div class="search-form">
                    <input type="text" id="searchInput" class="form-control" placeholder="Buscar por nombre o número de documento">
                    <button class="btn btn--primary" onclick="searchPatients()">Buscar</button>
                </div>
                <div id="searchResults" class="search-results"></div>
            </div>

            <div class="action-buttons">
                <button class="btn btn--primary" onclick="showSection('nuevoPatient')">Nuevo Paciente</button>
                <button class="btn btn--secondary" onclick="showControlSelection()">Control de Seguimiento</button>
                <button class="btn btn--info" onclick="showClinicalHistories()">Historias Clínicas Completas</button>
                <button class="btn btn--success" onclick="showSection('editPatients')">Editar Pacientes</button>
                <button class="btn btn--outline" onclick="exportData()">Exportar Datos CSV</button>
                <button class="btn btn--outline" onclick="logout()">Cerrar Sesión</button>
            </div>

            <!-- Cronograma de Controles Postoperatorios -->
            <div class="card schedule-card">
                <div class="card-header">
                    <h3>Cronograma de Controles Postoperatorios</h3>
                </div>
                <div class="card-body">
                    <div class="postop-schedule">
                        <div class="postop-timeline">
                            <div class="postop-item">
                                <div class="postop-week">
                                    <h4>1-2 Semanas Post-cirugía</h4>
                                </div>
                                <div class="postop-activities">
                                    <ul>
                                        <li>Primera consulta - Retiro de suturas, evaluación de cicatrización</li>
                                        <li>Control inicial</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="postop-item">
                                <div class="postop-week">
                                    <h4>3-4 Semanas</h4>
                                </div>
                                <div class="postop-activities">
                                    <ul>
                                        <li>Inicio de movilización activa asistida</li>
                                        <li>Cambio de fase</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="postop-item">
                                <div class="postop-week">
                                    <h4>6 Semanas</h4>
                                </div>
                                <div class="postop-activities">
                                    <ul>
                                        <li>Evaluación de ROM, inicio de fortalecimiento</li>
                                        <li>Cambio de fase</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="postop-item">
                                <div class="postop-week">
                                    <h4>12 Semanas</h4>
                                </div>
                                <div class="postop-activities">
                                    <ul>
                                        <li>Evaluación final, alta médica</li>
                                        <li>Control final</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sección Editar Pacientes -->
        <section id="editPatients" class="section">
            <div class="section-header">
                <h2>Editar Información de Pacientes</h2>
                <button class="btn btn--outline" onclick="showSection('dashboard')">Volver al Dashboard</button>
            </div>

            <div class="search-section">
                <div class="search-form">
                    <input type="text" id="editPatientSearch" class="form-control" placeholder="Buscar paciente por nombre o documento para editar">
                    <button class="btn btn--primary" onclick="searchPatientsForEdit()">Buscar</button>
                </div>
            </div>

            <div id="editPatientsList" class="edit-patients-list">
                <!-- Se llena dinámicamente -->
            </div>
        </section>

        <!-- Historias Clínicas Completas -->
        <section id="clinicalHistories" class="section">
            <div class="section-header">
                <h2>Historias Clínicas Completas</h2>
                <nav class="breadcrumb">
                    <span onclick="showSection('dashboard')" class="breadcrumb-link">Dashboard</span>
                    <span class="breadcrumb-separator">›</span>
                    <span class="breadcrumb-current">Historias Clínicas</span>
                </nav>
                <button class="btn btn--outline" onclick="showSection('dashboard')">Volver al Dashboard</button>
            </div>

            <div class="search-section">
                <div class="search-form">
                    <input type="text" id="clinicalHistorySearch" class="form-control" placeholder="Buscar paciente por nombre o documento">
                    <button class="btn btn--primary" onclick="searchClinicalHistories()">Buscar</button>
                </div>
            </div>

            <div id="clinicalHistoriesList" class="clinical-histories-list">
                <!-- Se llena dinámicamente -->
            </div>
        </section>

        <!-- Vista Individual de Historia Clínica -->
        <section id="individualClinicalHistory" class="section">
            <div class="section-header">
                <h2 id="clinicalHistoryPatientName">Historia Clínica</h2>
                <nav class="breadcrumb">
                    <span onclick="showSection('dashboard')" class="breadcrumb-link">Dashboard</span>
                    <span class="breadcrumb-separator">›</span>
                    <span onclick="showSection('clinicalHistories')" class="breadcrumb-link">Historias Clínicas</span>
                    <span class="breadcrumb-separator">›</span>
                    <span class="breadcrumb-current">Vista Individual</span>
                </nav>
                <div class="header-actions">
                    <button class="btn btn--primary" onclick="copyCompleteHistory()">Copiar Historia Clínica Completa</button>
                    <button class="btn btn--outline" onclick="showSection('clinicalHistories')">Volver a Lista</button>
                </div>
            </div>

            <div id="individualHistoryContent" class="individual-history-content">
                <!-- Se llena dinámicamente -->
            </div>
        </section>

        <!-- Resto del contenido HTML aquí (formularios, etc.) -->
        <!-- Por brevedad, estoy omitiendo el resto del contenido HTML que ya tienes -->
        <!-- Solo añade los scripts de Firebase como se muestra arriba -->

        <!-- Exercise Timer Modal -->
        <div id="exerciseTimerModal" class="modal hidden">
            <div class="modal-content exercise-modal">
                <div class="modal-header">
                    <h3 id="exerciseTitle">Ejercicio</h3>
                    <button class="btn btn--outline btn--sm" onclick="closeExerciseModal()">✕</button>
                </div>
                <div class="modal-body">
                    <div id="exerciseDescription" class="exercise-description"></div>
                    <div class="timer-display">
                        <div id="timerCircle" class="timer-circle">
                            <div id="timerText" class="timer-text">00:00</div>
                        </div>
                    </div>
                    <div class="timer-controls">
                        <button id="timerStartBtn" class="btn btn--primary" onclick="startTimer()">Iniciar</button>
                        <button id="timerPauseBtn" class="btn btn--secondary hidden" onclick="pauseTimer()">Pausar</button>
                        <button id="timerResetBtn" class="btn btn--outline" onclick="resetTimer()">Reiniciar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="modal hidden">
            <div class="modal-content edit-modal">
                <div class="modal-header">
                    <h3 id="editModalTitle">Editar Información</h3>
                    <button class="btn btn--outline btn--sm" onclick="closeEditModal()">✕</button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <div id="editFormContent"></div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn--primary">Guardar Cambios</button>
                            <button type="button" class="btn btn--secondary" onclick="closeEditModal()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmationModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Confirmar Cambios</h3>
                </div>
                <div class="modal-body">
                    <p id="confirmationMessage">¿Está seguro que desea guardar estos cambios?</p>
                    <div class="modal-actions">
                        <button class="btn btn--primary" onclick="confirmEdit()">Confirmar</button>
                        <button class="btn btn--secondary" onclick="cancelEdit()">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="spinner hidden">
            <div class="spinner-circle"></div>
        </div>
    </div>

    <!-- Tu archivo JavaScript con Firebase integrado -->
    <script src="app-firebase-integrado.js"></script>
    
    <script>
        // Status indicator para Firebase
        function updateFirebaseStatus(connected, message = '') {
            const status = document.getElementById('firebaseStatus');
            if (connected) {
                status.textContent = '🔥 Conectado a Firebase';
                status.className = 'firebase-status';
            } else {
                status.textContent = '❌ Error Firebase: ' + message;
                status.className = 'firebase-status error';
            }
        }
        
        // Verificar conexión Firebase al cargar
        window.addEventListener('load', () => {
            try {
                if (typeof firebase !== 'undefined' && typeof db !== 'undefined') {
                    updateFirebaseStatus(true);
                } else {
                    updateFirebaseStatus(false, 'No configurado');
                }
            } catch (error) {
                updateFirebaseStatus(false, error.message);
            }
        });
    </script>
</body>
</html>