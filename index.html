<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Evaluaci√≥n - Tendones Flexores</title>
    <link rel="stylesheet" href="style.css">

    <!-- Firebase SDK - Versi√≥n compatibilidad v9 -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <script>
    // Configuraci√≥n de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDwINxMSny7QtJNL6sYbEqbUwqRPITRSzE",
        authDomain: "lesion-de-flexores-un.firebaseapp.com",
        projectId: "lesion-de-flexores-un",
        storageBucket: "lesion-de-flexores-un.firebasestorage.app",
        messagingSenderId: "401340786156",
        appId: "1:401340786156:web:0a9a704001e4b8875d0cc9",
        measurementId: "G-523XCEBC8H"
    };


    // Inicializaci√≥n de Firebase (ya est√° bien)
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    console.log("Firebase inicializado correctamente");
    </script>


    <style>
        /* Firebase status indicator */
        .firebase-status {
            position: fixed;
            top: 15px;
            right: 15px;
            background: #4CAF50;
            color: white;
            padding: 12px 18px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .firebase-status.error {
            background: #f44336;
            animation: pulse 2s infinite;
        }

        .firebase-status.connecting {
            background: #ff9800;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Enhanced form styling for better visibility */
        .form-control {
            padding: 12px 16px !important;
            border: 2px solid #ddd !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            transition: all 0.3s ease !important;
        }

        .form-control:focus {
            border-color: #2c5aa0 !important;
            outline: none !important;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1) !important;
        }

        .btn {
            padding: 12px 24px !important;
            border-radius: 8px !important;
            font-weight: 500 !important;
            border: 2px solid transparent !important;
            transition: all 0.3s ease !important;
        }

        .btn--primary {
            background: #2c5aa0 !important;
            color: white !important;
            border-color: #2c5aa0 !important;
        }

        .btn--primary:hover {
            background: #1e4080 !important;
            border-color: #1e4080 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(44, 90, 160, 0.3) !important;
        }

        .btn--secondary {
            background: #6c757d !important;
            color: white !important;
            border-color: #6c757d !important;
        }

        .btn--secondary:hover {
            background: #5a6268 !important;
            border-color: #5a6268 !important;
        }

        .btn--outline {
            background: transparent !important;
            color: #2c5aa0 !important;
            border-color: #2c5aa0 !important;
        }

        .btn--outline:hover {
            background: #2c5aa0 !important;
            color: white !important;
        }

        .btn--info {
            background: #17a2b8 !important;
            color: white !important;
            border-color: #17a2b8 !important;
        }

        .btn--success {
            background: #28a745 !important;
            color: white !important;
            border-color: #28a745 !important;
        }

        /* Cards with better borders */
        .card {
            border: 2px solid #e9ecef !important;
            border-radius: 12px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            margin-bottom: 24px !important;
        }

        .card-header {
            background: #f8f9fa !important;
            border-bottom: 2px solid #e9ecef !important;
            border-radius: 10px 10px 0 0 !important;
            padding: 18px 24px !important;
        }

        .card-body {
            padding: 24px !important;
        }

        /* Dashboard improvements */
        .dashboard-stats {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)) !important;
            gap: 20px !important;
            margin: 24px 0 !important;
        }

        .stat-card {
            text-align: center !important;
            transition: transform 0.3s ease !important;
        }

        .stat-card:hover {
            transform: translateY(-2px) !important;
        }

        .stat-number {
            font-size: 2.5rem !important;
            font-weight: bold !important;
            color: #2c5aa0 !important;
        }

        /* Action buttons grid */
        .action-buttons {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
            gap: 16px !important;
            margin: 30px 0 !important;
        }

        /* Schedule card improvements */
        .schedule-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
        }

        .postop-timeline {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)) !important;
            gap: 20px !important;
        }

        .postop-item {
            background: white !important;
            border: 2px solid #dee2e6 !important;
            border-radius: 10px !important;
            padding: 20px !important;
            transition: all 0.3s ease !important;
        }

        .postop-item:hover {
            border-color: #2c5aa0 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(44, 90, 160, 0.1) !important;
        }

        .postop-week {
            color: #2c5aa0 !important;
            margin-bottom: 12px !important;
            border-bottom: 2px solid #e9ecef !important;
            padding-bottom: 8px !important;
        }

        .postop-activities ul {
            margin: 0 !important;
            padding-left: 20px !important;
        }

        .postop-activities li {
            margin-bottom: 8px !important;
            line-height: 1.5 !important;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2c5aa0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .action-buttons {
                grid-template-columns: 1fr !important;
            }

            .dashboard-stats {
                grid-template-columns: 1fr !important;
            }

            .postop-timeline {
                grid-template-columns: 1fr !important;
            }

            .firebase-status {
                top: 10px !important;
                right: 10px !important;
                padding: 8px 12px !important;
                font-size: 12px !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Firebase status indicator -->
    <div id="firebaseStatus" class="firebase-status connecting">Conectando a Firebase...</div>

    <div class="container">

        <!-- Pantalla de Acceso Inicial -->
        <section id="accessScreen" class="section active">
            <div class="access-screen">
                <div class="app-header">
                    <h1>Sistema de Evaluaci√≥n - Tendones Flexores</h1>
                    <p>Seguimiento de pacientes con lesiones en zonas I, II, III, IV y V</p>
                    <p><small>üî• <strong>Datos guardados en la nube con Firebase</strong></small></p>
                </div>

                <div class="access-buttons">
                    <button class="btn btn--primary" onclick="showSection('patientSection')">
                        Acceso Paciente
                    </button>
                    <button class="btn btn--secondary" onclick="showSection('doctorLogin')">
                        Acceso M√©dico
                    </button>
                </div>
            </div>
        </section>

        <!-- Login M√©dico -->
        <section id="doctorLogin" class="section">
            <div class="login-container">
                <div class="card">
                    <div class="card-header">
                        <h2>Acceso M√©dico</h2>
                        <p><small>üî• Los datos se sincronizan autom√°ticamente en la nube</small></p>
                    </div>
                    <div class="card-body">
                        <form id="doctorLoginForm">
                            <div class="form-group">
                                <label class="form-label">N√∫mero de C√©dula</label>
                                <input type="text" id="doctorId" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nombre Completo</label>
                                <input type="text" id="doctorName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contrase√±a</label>
                                <input type="password" id="doctorPassword" class="form-control" required>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn--primary">Ingresar</button>
                                <button type="button" class="btn btn--outline" onclick="showSection('accessScreen')">Volver</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Secci√≥n Paciente -->
        <section id="patientSection" class="section">
            <div class="section-header">
                <h2>Informaci√≥n para Pacientes</h2>
                <button class="btn btn--outline" onclick="showSection('accessScreen')">Volver</button>
            </div>

            <!-- Protocolos de Ejercicios -->
            <div class="card">
                <div class="card-header">
                    <h3>Protocolos de Ejercicios</h3>
                </div>
                <div class="card-body">
                    <div class="protocol-tabs">
                        <button class="tab-button active" onclick="showProtocol('KLEINERT')">KLEINERT</button>
                        <button class="tab-button" onclick="showProtocol('DURAN')">DURAN</button>
                        <button class="tab-button" onclick="showProtocol('ACTIVE_MOTION')">ACTIVE MOTION</button>
                    </div>
                    <div id="protocolContent" class="protocol-content">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Cuidados del Paciente -->
            <div class="card">
                <div class="card-header">
                    <h3>Cuidados del Paciente</h3>
                </div>
                <div class="card-body">
                    <div class="care-section">
                        <h4>Cuidados de F√©rula y Cicatriz</h4>

                        <div class="care-subsection">
                            <h5>Cuidado de la F√©rula</h5>
                            <ul class="care-list">
                                <li>Mantener seca y limpia</li>
                                <li>No remover sin indicaci√≥n m√©dica</li>
                                <li>Revisar ajuste diariamente</li>
                                <li>Reportar dolor, hinchaz√≥n o cambios de color</li>
                                <li>No mojarse durante el ba√±o</li>
                            </ul>
                        </div>

                        <div class="care-subsection">
                            <h5>Cuidado de la Cicatriz</h5>
                            <ul class="care-list">
                                <li>Mantener √°rea limpia y seca</li>
                                <li>Masaje cicatricial posterior a 3 semanas</li>
                                <li>Protecci√≥n solar durante 6 meses</li>
                                <li>Aplicar crema hidratante suave</li>
                                <li>Evitar exposici√≥n a productos qu√≠micos</li>
                            </ul>
                        </div>

                        <div class="care-subsection">
                            <h5>Signos de Alerta</h5>
                            <ul class="care-list">
                                <li>Aumento del dolor o inflamaci√≥n</li>
                                <li>Enrojecimiento o calor en la herida</li>
                                <li>Secreci√≥n con mal olor</li>
                                <li>Fiebre mayor a 38¬∞C</li>
                                <li>P√©rdida s√∫bita de movimiento</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dashboard M√©dico -->
        <section id="dashboard" class="section">
            <div id="doctorInfo" class="doctor-info">
                <!-- Se llena din√°micamente -->
            </div>

            <header class="app-header">
                <h1>Sistema de Evaluaci√≥n - Tendones Flexores</h1>
                <p>Panel de Control M√©dico</p>
                <p><small>üî• <strong>Datos sincronizados en Firebase</strong> - Compartidos entre todos los usuarios</small></p>
            </header>

            <div class="dashboard-stats">
                <div class="card stat-card">
                    <div class="card-body">
                        <h3>Total Pacientes</h3>
                        <div class="stat-number" id="totalPacientes">0</div>
                    </div>
                </div>

                <div class="card stat-card">
                    <div class="card-body">
                        <h3>Controles Pendientes</h3>
                        <div class="stat-number" id="controlesPendientes">0</div>
                    </div>
                </div>

                <div class="card stat-card">
                    <div class="card-body">
                        <h3>Pacientes con Controles Incompletos</h3>
                        <div class="stat-number" id="pacientesIncompletos">0</div>
                    </div>
                </div>
            </div>

            <div class="search-section">
                <h3>B√∫squeda de Pacientes</h3>
                <div class="search-form">
                    <input type="text" id="searchInput" class="form-control" placeholder="Buscar por nombre o n√∫mero de documento">
                    <button class="btn btn--primary" onclick="searchPatients()">Buscar</button>
                </div>
                <div id="searchResults" class="search-results"></div>
            </div>

            <div class="action-buttons">
                <button class="btn btn--primary" onclick="showSection('nuevoPatient')">Nuevo Paciente</button>
                <button class="btn btn--secondary" onclick="showControlSelection()">Control de Seguimiento</button>
                <button class="btn btn--info" onclick="showClinicalHistories()">Historias Cl√≠nicas Completas</button>
                <button class="btn btn--success" onclick="showSection('editPatients')">Editar Pacientes</button>
                <button class="btn btn--outline" onclick="exportData()">Exportar Datos CSV</button>
                <button class="btn btn--outline" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>

            <!-- Cronograma de Controles Postoperatorios -->
            <div class="card schedule-card">
                <div class="card-header">
                    <h3>Cronograma de Controles Postoperatorios</h3>
                </div>
                <div class="card-body">
                    <div class="postop-schedule">
                        <div class="postop-timeline">
                            <div class="postop-item">
                                <div class="postop-week">
                                    <h4>1-2 Semanas Post-cirug√≠a</h4>
                                </div>
                                <div class="postop-activities">
                                    <ul>
                                        <li>Primera consulta - Retiro de suturas, evaluaci√≥n de cicatrizaci√≥n</li>
                                        <li>Control inicial</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="postop-item">
                                <div class="postop-week">
                                    <h4>3-4 Semanas</h4>
                                </div>
                                <div class="postop-activities">
                                    <ul>
                                        <li>Inicio de movilizaci√≥n activa asistida</li>
                                        <li>Cambio de fase</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="postop-item">
                                <div class="postop-week">
                                    <h4>6 Semanas</h4>
                                </div>
                                <div class="postop-activities">
                                    <ul>
                                        <li>Evaluaci√≥n de ROM, inicio de fortalecimiento</li>
                                        <li>Cambio de fase</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="postop-item">
                                <div class="postop-week">
                                    <h4>12 Semanas</h4>
                                </div>
                                <div class="postop-activities">
                                    <ul>
                                        <li>Evaluaci√≥n final, alta m√©dica</li>
                                        <li>Control final</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Secci√≥n Nuevo Paciente -->
        <section id="nuevoPatient" class="section">
            <div class="section-header">
                <h2>Registro de Nuevo Paciente</h2>
                <nav class="breadcrumb">
                    <span onclick="showSection('dashboard')" class="breadcrumb-link">Dashboard</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-current">Nuevo Paciente</span>
                </nav>
                <button class="btn btn--outline" onclick="showSection('dashboard')">Volver al Dashboard</button>
            </div>

            <form id="newPatientForm" class="patient-form">
                <!-- Secci√≥n 1: Identificaci√≥n -->
                <div class="card">
                    <div class="card-header">
                        <h3>1. Identificaci√≥n del Paciente</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Fecha de Ingreso</label>
                                <input type="date" id="admissionDate" class="form-control" required onchange="calculateDaysToSurgery()">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tiempo de Evoluci√≥n hasta el ingreso (Horas)</label>
                                <input type="number" id="evolutionTime" class="form-control" min="0" required>
                            </div>

                            <div class="form-group col-span-2">
                                <label class="form-label">Nombre Completo</label>
                                <input type="text" id="fullName" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tipo de Documento</label>
                                <select id="documentType" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="C√©dula de Ciudadan√≠a">C√©dula de Ciudadan√≠a</option>
                                    <option value="Tarjeta de Identidad">Tarjeta de Identidad</option>
                                    <option value="Pasaporte">Pasaporte</option>
                                    <option value="Registro Civil">Registro Civil</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">N√∫mero de Documento</label>
                                <input type="text" id="documentNumber" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Edad</label>
                                <input type="number" id="age" class="form-control" min="0" max="120" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Sexo</label>
                                <select id="sex" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="Masculino">Masculino</option>
                                    <option value="Femenino">Femenino</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Nivel Educativo</label>
                                <select id="educationLevel" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="Primaria">Primaria</option>
                                    <option value="Secundaria">Secundaria</option>
                                    <option value="T√©cnico">T√©cnico</option>
                                    <option value="Tecn√≥logo">Tecn√≥logo</option>
                                    <option value="Universitario">Universitario</option>
                                    <option value="Especializaci√≥n">Especializaci√≥n</option>
                                    <option value="Maestr√≠a">Maestr√≠a</option>
                                    <option value="Doctorado">Doctorado</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Ocupaci√≥n Actual</label>
                                <input type="text" id="occupation" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Pa√≠s de Origen</label>
                                <input type="text" id="originCountry" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Ciudad de Nacimiento</label>
                                <input type="text" id="birthCity" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Direcci√≥n</label>
                                <input type="text" id="address" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Departamento</label>
                                <input type="text" id="department" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Ciudad de Residencia</label>
                                <input type="text" id="city" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tel√©fono de Contacto</label>
                                <input type="tel" id="phone" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Correo Electr√≥nico</label>
                                <input type="email" id="email" class="form-control">
                            </div>

                            <div class="form-group">
                                <label class="form-label">EPS</label>
                                <input type="text" id="eps" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tipo de Afiliaci√≥n</label>
                                <select id="affiliationType" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="CONTRIBUTIVO">CONTRIBUTIVO</option>
                                    <option value="SUBSIDIADO">SUBSIDIADO</option>
                                    <option value="BENEFICIARIO">BENEFICIARIO</option>
                                    <option value="AFILIADO">AFILIADO</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Lateralidad</label>
                                <select id="laterality" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="Derecho">Derecho</option>
                                    <option value="Izquierdo">Izquierdo</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Estrato</label>
                                <select id="estrato" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Religi√≥n</label>
                                <input type="text" id="religion" class="form-control">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Nombre del Acompa√±ante</label>
                                <input type="text" id="companionName" class="form-control">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Relaci√≥n con el Acompa√±ante</label>
                                <input type="text" id="companionRelation" class="form-control">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tel√©fono del Acompa√±ante</label>
                                <input type="tel" id="companionPhone" class="form-control">
                            </div>

                            <div class="form-group col-span-2">
                                <label class="form-label">Comorbilidades Actuales</label>
                                <textarea id="comorbilidadesActuales" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 2: Datos Iniciales -->
                <div class="card">
                    <div class="card-header">
                        <h3>2. Datos Iniciales del Trauma</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Miembro Lesionado</label>
                                <select id="miembroLesionado" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="Izquierdo">Izquierdo</option>
                                    <option value="Derecho">Derecho</option>
                                </select>
                            </div>

                            <div class="form-group col-span-2">
                                <label class="form-label">Zonas Lesionadas - Seleccionar todas las que apliquen</label>
                                <div class="checkbox-group">
                                    <label><input type="checkbox" id="zone1" value="I"> Zona I</label>
                                    <label><input type="checkbox" id="zone2" value="II"> Zona II</label>
                                    <label><input type="checkbox" id="zone3" value="III"> Zona III</label>
                                    <label><input type="checkbox" id="zone4" value="IV"> Zona IV</label>
                                    <label><input type="checkbox" id="zone5" value="V"> Zona V</label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Objeto</label>
                                <input type="text" id="object" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Etiolog√≠a</label>
                                <select id="etiology" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="CORTOPUNZANTE">CORTOPUNZANTE</option>
                                    <option value="CORTOCONTUNDENTE">CORTOCONTUNDENTE</option>
                                    <option value="APLASTAMIENTO">APLASTAMIENTO</option>
                                    <option value="EXPLOSIVO">EXPLOSIVO</option>
                                    <option value="CIZALLANTE">CIZALLANTE</option>
                                    <option value="COMBINADO">COMBINADO</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Mecanismo del Trauma</label>
                                <select id="traumaMechanism" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="ABIERTO">ABIERTO</option>
                                    <option value="CERRADO">CERRADO</option>
                                </select>
                            </div>

                            <div class="form-group col-span-2">
                                <label class="form-label">Descripci√≥n Prequir√∫rgica</label>
                                <textarea id="presurgicalDescription" class="form-control" rows="3"></textarea>
                            </div>

                            <div class="form-group col-span-2">
                                <label class="form-label">Tend√≥n Flexor Comprometido</label>
                                <div class="checkbox-group">
                                    <label><input type="checkbox" id="tendonfds" value="FDS"> FDS</label>
                                    <label><input type="checkbox" id="tendonfdp" value="FDP"> FDP</label>
                                    <label><input type="checkbox" id="tendonfpl" value="FPL"> FPL</label>
                                    <label><input type="checkbox" id="tendonfcu" value="FCU"> FCU</label>
                                    <label><input type="checkbox" id="tendonfcr" value="FCR"> FCR</label>
                                    <label><input type="checkbox" id="tendonpl" value="PL"> PL</label>
                                </div>
                            </div>

                            <div class="form-group col-span-2">
                                <label class="form-label">Descripci√≥n Tend√≥n Flexor Comprometido</label>
                                <textarea id="tendonDescription" class="form-control" rows="3"></textarea>
                            </div>

                            <div class="form-group col-span-2">
                                <label class="form-label">Lesi√≥n Asociada General (Seleccionar todas las que apliquen)</label>
                                <div class="checkbox-group">
                                    <label><input type="checkbox" id="injurynervioso" value="NERVIOSO"> NERVIOSO</label>
                                    <label><input type="checkbox" id="injuryoseo" value="√ìSEO"> √ìSEO</label>
                                    <label><input type="checkbox" id="injuryvascular" value="VASCULAR"> VASCULAR</label>
                                    <label><input type="checkbox" id="injurymuscular" value="MUSCULAR"> MUSCULAR</label>
                                    <label><input type="checkbox" id="injuryligamentaria" value="LIGAMENTARIA"> LIGAMENTARIA</label>
                                    <label><input type="checkbox" id="injurycapsula" value="C√ÅPSULA ARTICULAR"> C√ÅPSULA ARTICULAR</label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Lesi√≥n Asociada Espec√≠fica</label>
                                <input type="text" id="specificAssociatedInjury" class="form-control">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tenorrafia (hilos)</label>
                                <input type="text" id="tenorrhaphyThreads" class="form-control">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Reparaci√≥n</label>
                                <select id="repairType" class="form-control">
                                    <option value="">Seleccionar</option>
                                    <option value="CENTRAL">CENTRAL</option>
                                    <option value="EPITENDINOSA">EPITENDINOSA</option>
                                    <option value="MIXTA">MIXTA</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">T√©cnica Reparaci√≥n</label>
                                <input type="text" id="repairTechnique" class="form-control">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tenolisis</label>
                                <select id="tenolysis" class="form-control">
                                    <option value="">Seleccionar</option>
                                    <option value="S√≠">S√≠</option>
                                    <option value="No">No</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">D√≠as para Cirug√≠a (Calculado autom√°ticamente)</label>
                                <input type="number" id="daysToSurgery" class="form-control" readonly>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Fecha Quir√∫rgica</label>
                                <input type="date" id="surgeryDate" class="form-control" onchange="calculateDaysToSurgery()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 3: Escalas de Evaluaci√≥n -->
                <div class="card">
                    <div class="card-header">
                        <h3>3. Escalas de Evaluaci√≥n Inicial</h3>
                    </div>
                    <div class="card-body">
                        <h4>BMRC Scale - Sensitivo <span class="tooltip" title="Escala S0-S4. S0:Sin sensaci√≥n, S1:Dolor profundo, S2:Dolor y tacto, S3:Discriminaci√≥n 15-20mm, S4:Discriminaci√≥n <7mm">‚ÑπÔ∏è</span></h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Mediano</label>
                                <select id="bmrcSensoryMedian" class="form-control">
                                    <option value="">Seleccionar</option>
                                    <option value="0">S0 - Sin sensaci√≥n</option>
                                    <option value="1">S1 - Sensaci√≥n de dolor profundo</option>
                                    <option value="2">S2 - Sensaci√≥n de dolor y tacto</option>
                                    <option value="2.5">S2+ - Sensaci√≥n de dolor y tacto con cierta sobrereacci√≥n</option>
                                    <option value="3">S3 - Como S2+, sin sobrereacci√≥n y discriminaci√≥n est√°tica 15-20 mm</option>
                                    <option value="3.5">S3+ - Como S3+, discriminaci√≥n est√°tica 7-15 mm</option>
                                    <option value="4">S4 - Como S3+, discriminaci√≥n est√°tica <7 mm</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cubital</label>
                                <select id="bmrcSensoryUlnar" class="form-control">
                                    <option value="">Seleccionar</option>
                                    <option value="0">S0 - Sin sensaci√≥n</option>
                                    <option value="1">S1 - Sensaci√≥n de dolor profundo</option>
                                    <option value="2">S2 - Sensaci√≥n de dolor y tacto</option>
                                    <option value="2.5">S2+ - Sensaci√≥n de dolor y tacto con cierta sobrereacci√≥n</option>
                                    <option value="3">S3 - Como S2+, sin sobrereacci√≥n y discriminaci√≥n est√°tica 15-20 mm</option>
                                    <option value="3.5">S3+ - Como S3+, discriminaci√≥n est√°tica 7-15 mm</option>
                                    <option value="4">S4 - Como S3+, discriminaci√≥n est√°tica <7 mm</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Radial</label>
                                <select id="bmrcSensoryRadial" class="form-control">
                                    <option value="">Seleccionar</option>
                                    <option value="0">S0 - Sin sensaci√≥n</option>
                                    <option value="1">S1 - Sensaci√≥n de dolor profundo</option>
                                    <option value="2">S2 - Sensaci√≥n de dolor y tacto</option>
                                    <option value="2.5">S2+ - Sensaci√≥n de dolor y tacto con cierta sobrereacci√≥n</option>
                                    <option value="3">S3 - Como S2+, sin sobrereacci√≥n y discriminaci√≥n est√°tica 15-20 mm</option>
                                    <option value="3.5">S3+ - Como S3+, discriminaci√≥n est√°tica 7-15 mm</option>
                                    <option value="4">S4 - Como S3+, discriminaci√≥n est√°tica <7 mm</option>
                                </select>
                            </div>
                        </div>

                        <h4>BMRC Scale - Motor <span class="tooltip" title="Escala M0-M5. M0:Sin contracci√≥n, M1:Contracci√≥n sin movimiento, M2:Movimiento sin gravedad, M3:Contra gravedad sin resistencia, M4:Con resistencia parcial, M5:Fuerza normal">‚ÑπÔ∏è</span></h4>

                        <div class="bmrc-motor-section">
                            <h5>FDS por Dedo</h5>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">FDS Dedo 2</label>
                                    <select id="bmrcMotorFds2" class="form-control">
                                        <option value="">Seleccionar</option>
                                        <option value="0">M0 - Sin contracci√≥n muscular</option>
                                        <option value="1">M1 - Contracci√≥n muscular que no resulta en movimiento articular</option>
                                        <option value="2">M2 - Contracci√≥n muscular con movimiento excluyendo gravedad</option>
                                        <option value="3">M3 - Contracci√≥n muscular efectiva contra gravedad pero no supera resistencia</option>
                                        <option value="4">M4 - Contracci√≥n muscular que supera cierta resistencia</option>
                                        <option value="5">M5 - Fuerza muscular normal</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">FDS Dedo 3</label>
                                    <select id="bmrcMotorFds3" class="form-control">
                                        <option value="">Seleccionar</option>
                                        <option value="0">M0 - Sin contracci√≥n muscular</option>
                                        <option value="1">M1 - Contracci√≥n muscular que no resulta en movimiento articular</option>
                                        <option value="2">M2 - Contracci√≥n muscular con movimiento excluyendo gravedad</option>
                                        <option value="3">M3 - Contracci√≥n muscular efectiva contra gravedad pero no supera resistencia</option>
                                        <option value="4">M4 - Contracci√≥n muscular que supera cierta resistencia</option>
                                        <option value="5">M5 - Fuerza muscular normal</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">FDS Dedo 4</label>
                                    <select id="bmrcMotorFds4" class="form-control">
                                        <option value="">Seleccionar</option>
                                        <option value="0">M0 - Sin contracci√≥n muscular</option>
                                        <option value="1">M1 - Contracci√≥n muscular que no resulta en movimiento articular</option>
                                        <option value="2">M2 - Contracci√≥n muscular con movimiento excluyendo gravedad</option>
                                        <option value="3">M3 - Contracci√≥n muscular efectiva contra gravedad pero no supera resistencia</option>
                                        <option value="4">M4 - Contracci√≥n muscular que supera cierta resistencia</option>
                                        <option value="5">M5 - Fuerza muscular normal</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">FDS Dedo 5</label>
                                    <select id="bmrcMotorFds5" class="form-control">
                                        <option value="">Seleccionar</option>
                                        <option value="0">M0 - Sin contracci√≥n muscular</option>
                                        <option value="1">M1 - Contracci√≥n muscular que no resulta en movimiento articular</option>
                                        <option value="2">M2 - Contracci√≥n muscular con movimiento excluyendo gravedad</option>
                                        <option value="3">M3 - Contracci√≥n muscular efectiva contra gravedad pero no supera resistencia</option>
                                        <option value="4">M4 - Contracci√≥n muscular que supera cierta resistencia</option>
                                        <option value="5">M5 - Fuerza muscular normal</option>
                                    </select>
                                </div>
                            </div>

                            <h5>FDP por Dedo</h5>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">FDP Dedo 2</label>
                                    <select id="bmrcMotorFdp2" class="form-control">
                                        <option value="">Seleccionar</option>
                                        <option value="0">M0 - Sin contracci√≥n muscular</option>
                                        <option value="1">M1 - Contracci√≥n muscular que no resulta en movimiento articular</option>
                                        <option value="2">M2 - Contracci√≥n muscular con movimiento excluyendo gravedad</option>
                                        <option value="3">M3 - Contracci√≥n muscular efectiva contra gravedad pero no supera resistencia</option>
                                        <option value="4">M4 - Contracci√≥n muscular que supera cierta resistencia</option>
                                        <option value="5">M5 - Fuerza muscular normal</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">FDP Dedo 3</label>
                                    <select id="bmrcMotorFdp3" class="form-control">
                                        <option value="">Seleccionar</option>
                                        <option value="0">M0 - Sin contracci√≥n muscular</option>
                                        <option value="1">M1 - Contracci√≥n muscular que no resulta en movimiento articular</option>
                                        <option value="2">M2 - Contracci√≥n muscular con movimiento excluyendo gravedad</option>
                                        <option value="3">M3 - Contracci√≥n muscular efectiva contra gravedad pero no supera resistencia</option>
                                        <option value="4">M4 - Contracci√≥n muscular que supera cierta resistencia</option>
                                        <option value="5">M5 - Fuerza muscular normal</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">FDP Dedo 4</label>
                                    <select id="bmrcMotorFdp4" class="form-control">
                                        <option value="">Seleccionar</option>
                                        <option value="0">M0 - Sin contracci√≥n muscular</option>
                                        <option value="1">M1 - Contracci√≥n muscular que no resulta en movimiento articular</option>
                                        <option value="2">M2 - Contracci√≥n muscular con movimiento excluyendo gravedad</option>
                                        <option value="3">M3 - Contracci√≥n muscular efectiva contra gravedad pero no supera resistencia</option>
                                        <option value="4">M4 - Contracci√≥n muscular que supera cierta resistencia</option>
                                        <option value="5">M5 - Fuerza muscular normal</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">FDP Dedo 5</label>
                                    <select id="bmrcMotorFdp5" class="form-control">
                                        <option value="">Seleccionar</option>
                                        <option value="0">M0 - Sin contracci√≥n muscular</option>
                                        <option value="1">M1 - Contracci√≥n muscular que no resulta en movimiento articular</option>
                                        <option value="2">M2 - Contracci√≥n muscular con movimiento excluyendo gravedad</option>
                                        <option value="3">M3 - Contracci√≥n muscular efectiva contra gravedad pero no supera resistencia</option>
                                        <option value="4">M4 - Contracci√≥n muscular que supera cierta resistencia</option>
                                        <option value="5">M5 - Fuerza muscular normal</option>
                                    </select>
                                </div>
                            </div>

                            <h5>Otros M√∫sculos</h5>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">FPL</label>
                                    <select id="bmrcMotorFpl" class="form-control">
                                        <option value="">Seleccionar</option>
                                        <option value="0">M0 - Sin contracci√≥n muscular</option>
                                        <option value="1">M1 - Contracci√≥n muscular que no resulta en movimiento articular</option>
                                        <option value="2">M2 - Contracci√≥n muscular con movimiento excluyendo gravedad</option>
                                        <option value="3">M3 - Contracci√≥n muscular efectiva contra gravedad pero no supera resistencia</option>
                                        <option value="4">M4 - Contracci√≥n muscular que supera cierta resistencia</option>
                                        <option value="5">M5 - Fuerza muscular normal</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">FCU</label>
                                    <select id="bmrcMotorFcu" class="form-control">
                                        <option value="">Seleccionar</option>
                                        <option value="0">M0 - Sin contracci√≥n muscular</option>
                                        <option value="1">M1 - Contracci√≥n muscular que no resulta en movimiento articular</option>
                                        <option value="2">M2 - Contracci√≥n muscular con movimiento excluyendo gravedad</option>
                                        <option value="3">M3 - Contracci√≥n muscular efectiva contra gravedad pero no supera resistencia</option>
                                        <option value="4">M4 - Contracci√≥n muscular que supera cierta resistencia</option>
                                        <option value="5">M5 - Fuerza muscular normal</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">FCR</label>
                                    <select id="bmrcMotorFcr" class="form-control">
                                        <option value="">Seleccionar</option>
                                        <option value="0">M0 - Sin contracci√≥n muscular</option>
                                        <option value="1">M1 - Contracci√≥n muscular que no resulta en movimiento articular</option>
                                        <option value="2">M2 - Contracci√≥n muscular con movimiento excluyendo gravedad</option>
                                        <option value="3">M3 - Contracci√≥n muscular efectiva contra gravedad pero no supera resistencia</option>
                                        <option value="4">M4 - Contracci√≥n muscular que supera cierta resistencia</option>
                                        <option value="5">M5 - Fuerza muscular normal</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">PL</label>
                                    <select id="bmrcMotorPl" class="form-control">
                                        <option value="">Seleccionar</option>
                                        <option value="0">M0 - Sin contracci√≥n muscular</option>
                                        <option value="1">M1 - Contracci√≥n muscular que no resulta en movimiento articular</option>
                                        <option value="2">M2 - Contracci√≥n muscular con movimiento excluyendo gravedad</option>
                                        <option value="3">M3 - Contracci√≥n muscular efectiva contra gravedad pero no supera resistencia</option>
                                        <option value="4">M4 - Contracci√≥n muscular que supera cierta resistencia</option>
                                        <option value="5">M5 - Fuerza muscular normal</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn--primary">Guardar Paciente</button>
                    <button type="button" class="btn btn--secondary" onclick="showSection('dashboard')">Cancelar</button>
                </div>
            </form>
        </section>

        <!-- Control de Seguimiento -->
        <section id="followUpControl" class="section">
            <div class="section-header">
                <h2>Control de Seguimiento</h2>
                <nav class="breadcrumb">
                    <span onclick="showSection('dashboard')" class="breadcrumb-link">Dashboard</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-current">Control de Seguimiento</span>
                </nav>
                <button class="btn btn--outline" onclick="showSection('dashboard')">Volver al Dashboard</button>
            </div>

            <!-- Selecci√≥n de Paciente -->
            <div id="patientSelection" class="patient-selection">
                <div class="card">
                    <div class="card-header">
                        <h3>Seleccionar Paciente</h3>
                    </div>
                    <div class="card-body">
                        <div class="search-form">
                            <input type="text" id="followUpSearch" class="form-control" placeholder="Buscar paciente por nombre o documento">
                            <button class="btn btn--primary" onclick="searchPatientsForFollowUp()">Buscar</button>
                        </div>
                        <div id="followUpSearchResults" class="search-results"></div>
                    </div>
                </div>
            </div>

            <!-- Formulario de Control -->
            <form id="followUpForm" class="patient-form hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 id="selectedPatientName">Paciente Seleccionado</h3>
                        <div class="week-selection">
                            <label class="form-label">Semana de Control</label>
                            <select id="followUpWeek" class="form-control" required onchange="loadExistingFollowUp()">
                                <option value="">Seleccionar semana...</option>
                                <option value="1">Semana 1</option>
                                <option value="3">Semana 3</option>
                                <option value="6">Semana 6</option>
                                <option value="12">Semana 12</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Protocolo Usado</label>
                                <select id="protocolUsed" class="form-control">
                                    <option value="">Seleccionar</option>
                                    <option value="KLEINERT">KLEINERT</option>
                                    <option value="DURAN">DURAN</option>
                                    <option value="ACTIVE_MOTION">ACTIVE MOTION</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Terapias Completas</label>
                                <select id="completeTherapies" class="form-control" onchange="toggleIncompleteReason()">
                                    <option value="">Seleccionar</option>
                                    <option value="true">S√≠</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <div class="form-group col-span-2" id="incompleteReasonGroup" style="display: none;">
                                <label class="form-label">¬øPor qu√© incompletas?</label>
                                <textarea id="incompleteReason" class="form-control" rows="2"></textarea>
                            </div>

                            <div class="form-group col-span-2">
                                <label class="form-label">Complicaciones</label>
                                <textarea id="complicaciones" class="form-control" rows="2"></textarea>
                            </div>

                            <div class="form-group col-span-2">
                                <label class="form-label">Reintervenci√≥n Quir√∫rgica</label>
                                <input type="text" id="reintervencionQuirurgica" class="form-control">
                            </div>
                        </div>

                        <!-- Goniometr√≠a con c√°lculos autom√°ticos TAM por dedo -->
                        <h4>Goniometr√≠a - Mediciones por Dedo <span class="tooltip" title="Medir grados de flexi√≥n en MCF, IFP, IFD de cada dedo">‚ÑπÔ∏è</span></h4>
                        <div id="goniometryMeasurements" class="goniometry-grid">
                            <!-- Se genera din√°micamente -->
                        </div>

                        <div class="calculation-results">
                            <h4>Resultados TAM por Dedo</h4>
                            <div id="tamByFingerResults" class="tam-by-finger-results">
                                <!-- Se genera din√°micamente -->
                            </div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Strickland %</label>
                                    <input type="number" id="stricklandResult" class="form-control" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Clasificaci√≥n Strickland</label>
                                    <input type="text" id="stricklandClassification" class="form-control" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Quick DASH Completo -->
                        <h4>Cuestionario QuickDASH <span class="tooltip" title="Cuestionario de 11 preguntas. Escala 1-5 cada pregunta. Se calcula autom√°ticamente el puntaje total y grado de discapacidad">‚ÑπÔ∏è</span></h4>
                        <div id="quickDashQuestions" class="quickdash-section">
                            <!-- Se genera din√°micamente -->
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Quick DASH (Calculado)</label>
                                <input type="number" id="quickDashScore" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Grado de Discapacidad</label>
                                <input type="text" id="dashDisabilityGrade" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Retorno a ocupaci√≥n previa</label>
                                <select id="returnToPreviousOccupation" class="form-control" onchange="toggleReturnTimeField()">
                                    <option value="">Seleccionar</option>
                                    <option value="true">S√≠</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cambio de ocupaci√≥n</label>
                                <select id="occupationChange" class="form-control">
                                    <option value="">Seleccionar</option>
                                    <option value="true">S√≠</option>
                                    <option value="false">No</option>
                                    <option value="NO APLICA">NO APLICA</option>
                                </select>
                            </div>
                            <div class="form-group" id="returnTimeGroup" style="display: none;">
                                <label class="form-label">Tiempo retorno laboral (Meses)</label>
                                <input type="number" id="returnTimeMonths" class="form-control" min="0">
                            </div>
                        </div>

                        <!-- Escalas de Evaluaci√≥n en el Control -->
                        <h4>BMRC Scale - Sensitivo <span class="tooltip" title="Escala S0-S4. S0:Sin sensaci√≥n, S1:Dolor profundo, S2:Dolor y tacto, S3:Discriminaci√≥n 15-20mm, S4:Discriminaci√≥n <7mm">‚ÑπÔ∏è</span></h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Mediano</label>
                                <select id="followUpBmrcSensoryMedian" class="form-control">
                                    <option value="">Seleccionar</option>
                                    <option value="0">S0 - Sin sensaci√≥n</option>
                                    <option value="1">S1 - Sensaci√≥n de dolor profundo</option>
                                    <option value="2">S2 - Sensaci√≥n de dolor y tacto</option>
                                    <option value="2.5">S2+ - Sensaci√≥n de dolor y tacto con cierta sobrereacci√≥n</option>
                                    <option value="3">S3 - Como S2+, sin sobrereacci√≥n y discriminaci√≥n est√°tica 15-20 mm</option>
                                    <option value="3.5">S3+ - Como S3+, discriminaci√≥n est√°tica 7-15 mm</option>
                                    <option value="4">S4 - Como S3+, discriminaci√≥n est√°tica <7 mm</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cubital</label>
                                <select id="followUpBmrcSensoryUlnar" class="form-control">
                                    <option value="">Seleccionar</option>
                                    <option value="0">S0 - Sin sensaci√≥n</option>
                                    <option value="1">S1 - Sensaci√≥n de dolor profundo</option>
                                    <option value="2">S2 - Sensaci√≥n de dolor y tacto</option>
                                    <option value="2.5">S2+ - Sensaci√≥n de dolor y tacto con cierta sobrereacci√≥n</option>
                                    <option value="3">S3 - Como S2+, sin sobrereacci√≥n y discriminaci√≥n est√°tica 15-20 mm</option>
                                    <option value="3.5">S3+ - Como S3+, discriminaci√≥n est√°tica 7-15 mm</option>
                                    <option value="4">S4 - Como S3+, discriminaci√≥n est√°tica <7 mm</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Radial</label>
                                <select id="followUpBmrcSensoryRadial" class="form-control">
                                    <option value="">Seleccionar</option>
                                    <option value="0">S0 - Sin sensaci√≥n</option>
                                    <option value="1">S1 - Sensaci√≥n de dolor profundo</option>
                                    <option value="2">S2 - Sensaci√≥n de dolor y tacto</option>
                                    <option value="2.5">S2+ - Sensaci√≥n de dolor y tacto con cierta sobrereacci√≥n</option>
                                    <option value="3">S3 - Como S2+, sin sobrereacci√≥n y discriminaci√≥n est√°tica 15-20 mm</option>
                                    <option value="3.5">S3+ - Como S3+, discriminaci√≥n est√°tica 7-15 mm</option>
                                    <option value="4">S4 - Como S3+, discriminaci√≥n est√°tica <7 mm</option>
                                </select>
                            </div>
                        </div>

                        <!-- BMRC Scale Motor -->
                        <h4>BMRC Scale - Motor <span class="tooltip" title="Escala M0-M5. M0:Sin contracci√≥n, M1:Contracci√≥n sin movimiento, M2:Movimiento sin gravedad, M3:Contra gravedad sin resistencia, M4:Con resistencia parcial, M5:Fuerza normal">‚ÑπÔ∏è</span></h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">FPL</label>
                                <select id="followUpBmrcMotorFpl" class="form-control">
                                    <option value="">Seleccionar</option>
                                    <option value="0">M0 - Sin contracci√≥n muscular</option>
                                    <option value="1">M1 - Contracci√≥n muscular que no resulta en movimiento articular</option>
                                    <option value="2">M2 - Contracci√≥n muscular con movimiento excluyendo gravedad</option>
                                    <option value="3">M3 - Contracci√≥n muscular efectiva contra gravedad pero no supera resistencia</option>
                                    <option value="4">M4 - Contracci√≥n muscular que supera cierta resistencia</option>
                                    <option value="5">M5 - Fuerza muscular normal</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">FCU</label>
                                <select id="followUpBmrcMotorFcu" class="form-control">
                                    <option value="">Seleccionar</option>
                                    <option value="0">M0 - Sin contracci√≥n muscular</option>
                                    <option value="1">M1 - Contracci√≥n muscular que no resulta en movimiento articular</option>
                                    <option value="2">M2 - Contracci√≥n muscular con movimiento excluyendo gravedad</option>
                                    <option value="3">M3 - Contracci√≥n muscular efectiva contra gravedad pero no supera resistencia</option>
                                    <option value="4">M4 - Contracci√≥n muscular que supera cierta resistencia</option>
                                    <option value="5">M5 - Fuerza muscular normal</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">FCR</label>
                                <select id="followUpBmrcMotorFcr" class="form-control">
                                    <option value="">Seleccionar</option>
                                    <option value="0">M0 - Sin contracci√≥n muscular</option>
                                    <option value="1">M1 - Contracci√≥n muscular que no resulta en movimiento articular</option>
                                    <option value="2">M2 - Contracci√≥n muscular con movimiento excluyendo gravedad</option>
                                    <option value="3">M3 - Contracci√≥n muscular efectiva contra gravedad pero no supera resistencia</option>
                                    <option value="4">M4 - Contracci√≥n muscular que supera cierta resistencia</option>
                                    <option value="5">M5 - Fuerza muscular normal</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">PL</label>
                                <select id="followUpBmrcMotorPl" class="form-control">
                                    <option value="">Seleccionar</option>
                                    <option value="0">M0 - Sin contracci√≥n muscular</option>
                                    <option value="1">M1 - Contracci√≥n muscular que no resulta en movimiento articular</option>
                                    <option value="2">M2 - Contracci√≥n muscular con movimiento excluyendo gravedad</option>
                                    <option value="3">M3 - Contracci√≥n muscular efectiva contra gravedad pero no supera resistencia</option>
                                    <option value="4">M4 - Contracci√≥n muscular que supera cierta resistencia</option>
                                    <option value="5">M5 - Fuerza muscular normal</option>
                                </select>
                            </div>
                        </div>

                        <!-- Dinam√≥metro -->
                        <h4>Dinam√≥metro (lb)</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Izquierda</label>
                                <input type="number" id="dynamometerLeft" class="form-control" min="0" step="0.1" onchange="calculateDynamometerDifference()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Derecha</label>
                                <input type="number" id="dynamometerRight" class="form-control" min="0" step="0.1" onchange="calculateDynamometerDifference()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Diferencia</label>
                                <input type="number" id="dynamometerDifference" class="form-control" readonly>
                            </div>
                        </div>

                        <!-- Distancia U√±a-Palma -->
                        <h4>Distancia U√±a-Palma (mm) <span class="tooltip" title="Medir en mm desde la punta del dedo hasta la palma con flexi√≥n m√°xima">‚ÑπÔ∏è</span></h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Dedo 2</label>
                                <input type="number" id="nailPalmDistance2" class="form-control" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Dedo 3</label>
                                <input type="number" id="nailPalmDistance3" class="form-control" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Dedo 4</label>
                                <input type="number" id="nailPalmDistance4" class="form-control" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Dedo 5</label>
                                <input type="number" id="nailPalmDistance5" class="form-control" min="0">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn--primary">Guardar Control</button>
                    <button type="button" class="btn btn--secondary" onclick="cancelFollowUp()">Cancelar</button>
                </div>
            </form>
        </section>

        <!-- Secci√≥n Editar Pacientes -->
        <section id="editPatients" class="section">
            <div class="section-header">
                <h2>Editar Informaci√≥n de Pacientes</h2>
                <button class="btn btn--outline" onclick="showSection('dashboard')">Volver al Dashboard</button>
            </div>

            <div class="search-section">
                <div class="search-form">
                    <input type="text" id="editPatientSearch" class="form-control" placeholder="Buscar paciente por nombre o documento para editar">
                    <button class="btn btn--primary" onclick="searchPatientsForEdit()">Buscar</button>
                </div>
            </div>

            <div id="editPatientsList" class="edit-patients-list">
                <!-- Se llena din√°micamente -->
            </div>
        </section>

        <!-- Historias Cl√≠nicas Completas -->
        <section id="clinicalHistories" class="section">
            <div class="section-header">
                <h2>Historias Cl√≠nicas Completas</h2>
                <nav class="breadcrumb">
                    <span onclick="showSection('dashboard')" class="breadcrumb-link">Dashboard</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-current">Historias Cl√≠nicas</span>
                </nav>
                <button class="btn btn--outline" onclick="showSection('dashboard')">Volver al Dashboard</button>
            </div>

            <div class="search-section">
                <div class="search-form">
                    <input type="text" id="clinicalHistorySearch" class="form-control" placeholder="Buscar paciente por nombre o documento">
                    <button class="btn btn--primary" onclick="searchClinicalHistories()">Buscar</button>
                </div>
            </div>

            <div id="clinicalHistoriesList" class="clinical-histories-list">
                <!-- Se llena din√°micamente -->
            </div>
        </section>

        <!-- Vista Individual de Historia Cl√≠nica -->
        <section id="individualClinicalHistory" class="section">
            <div class="section-header">
                <h2 id="clinicalHistoryPatientName">Historia Cl√≠nica</h2>
                <nav class="breadcrumb">
                    <span onclick="showSection('dashboard')" class="breadcrumb-link">Dashboard</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span onclick="showSection('clinicalHistories')" class="breadcrumb-link">Historias Cl√≠nicas</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-current">Vista Individual</span>
                </nav>
                <div class="header-actions">
                    <button class="btn btn--primary" onclick="copyCompleteHistory()">Copiar Historia Cl√≠nica Completa</button>
                    <button class="btn btn--outline" onclick="showSection('clinicalHistories')">Volver a Lista</button>
                </div>
            </div>

            <div id="individualHistoryContent" class="individual-history-content">
                <!-- Se llena din√°micamente -->
            </div>
        </section>

        <!-- Exercise Timer Modal -->
        <div id="exerciseTimerModal" class="modal hidden">
            <div class="modal-content exercise-modal">
                <div class="modal-header">
                    <h3 id="exerciseTitle">Ejercicio</h3>
                    <button class="btn btn--outline btn--sm" onclick="closeExerciseModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <div id="exerciseDescription" class="exercise-description"></div>
                    <div class="timer-display">
                        <div id="timerCircle" class="timer-circle">
                            <div id="timerText" class="timer-text">00:00</div>
                        </div>
                    </div>
                    <div class="timer-controls">
                        <button id="timerStartBtn" class="btn btn--primary" onclick="startTimer()">Iniciar</button>
                        <button id="timerPauseBtn" class="btn btn--secondary hidden" onclick="pauseTimer()">Pausar</button>
                        <button id="timerResetBtn" class="btn btn--outline" onclick="resetTimer()">Reiniciar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="modal hidden">
            <div class="modal-content edit-modal">
                <div class="modal-header">
                    <h3 id="editModalTitle">Editar Informaci√≥n</h3>
                    <button class="btn btn--outline btn--sm" onclick="closeEditModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <div id="editFormContent"></div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn--primary">Guardar Cambios</button>
                            <button type="button" class="btn btn--secondary" onclick="closeEditModal()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmationModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Confirmar Cambios</h3>
                </div>
                <div class="modal-body">
                    <p id="confirmationMessage">¬øEst√° seguro que desea guardar estos cambios?</p>
                </div>
                <div class="modal-actions">
                    <button class="btn btn--primary" onclick="confirmEdit()">Confirmar</button>
                    <button class="btn btn--secondary" onclick="cancelEdit()">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="spinner hidden">
            <div class="spinner-circle"></div>
        </div>
    </div>

    <!-- JavaScript Firebase integrado DEBE ir al final -->
    <script src="app-firebase-integrado.js"></script>

    <script>
        // Firebase Status Management
        function updateFirebaseStatus(connected, message = '') {
            const status = document.getElementById('firebaseStatus');
            if (connected) {
                status.textContent = 'üî• Conectado a Firebase';
                status.className = 'firebase-status';
            } else {
                status.textContent = '‚ùå Error Firebase: ' + message;
                status.className = 'firebase-status error';
            }
        }

        // Firebase Connection Test
        window.addEventListener('load', () => {
            const loadingOverlay = document.getElementById('loadingOverlay');

            setTimeout(() => {
                try {
                    if (typeof firebase !== 'undefined' && typeof db !== 'undefined') {
                        // Test Firebase connection
                        db.collection('patients').limit(1).get()
                            .then(() => {
                                updateFirebaseStatus(true);
                                console.log('‚úÖ Firebase conectado y funcionando correctamente');
                            })
                            .catch((error) => {
                                updateFirebaseStatus(false, 'Error de conexi√≥n');
                                console.error('‚ùå Error conectando a Firebase:', error);
                            });
                    } else {
                        updateFirebaseStatus(false, 'SDK no cargado');
                        console.error('‚ùå Firebase no est√° definido');
                    }
                } catch (error) {
                    updateFirebaseStatus(false, error.message);
                    console.error('‚ùå Error inicializando Firebase:', error);
                }

                // Hide loading overlay
                loadingOverlay.classList.add('hidden');
            }, 1500);
        });

        // Global error handler
        window.addEventListener('error', (event) => {
            if (event.message.includes('firebase')) {
                updateFirebaseStatus(false, 'Error en tiempo de ejecuci√≥n');
            }
        });
    </script>
</body>
</html>
