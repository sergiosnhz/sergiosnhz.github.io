<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Evaluaci√≥n - Tendones Flexores</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase SDK - Versi√≥n compatibilidad v9 -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AZaSyDwTNxMSny7QtJNL6sYbEqbUwqRPITRSzE",
            authDomain: "lesion-de-flexores-un.firebaseapp.com",
            projectId: "lesion-de-flexores-un",
            storageBucket: "lesion-de-flexores-un.appspot.com",
            messagingSenderId: "401340786156",
            appId: "1:401340786156:web:0a9a704001e4b8875d0cc9",
            measurementId: "G-523XECBC8H"
        };

        // Inicializaci√≥n de Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        console.log('üî• Firebase inicializado correctamente');
    </script>
    
    <style>
        /* Firebase status indicator */
        .firebase-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .firebase-status.error {
            background: #f44336;
            animation: pulse 2s infinite;
        }
        
        .firebase-status.connecting {
            background: #ff9800;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2c5aa0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Firebase status indicator -->
    <div id="firebaseStatus" class="firebase-status connecting">Conectando a Firebase...</div>
    
    <div class="container">
        
        <!-- Pantalla de Acceso Inicial -->
        <section id="accessScreen" class="section active">
            <div class="access-screen">
                <div class="app-header">
                    <h1>Sistema de Evaluaci√≥n - Tendones Flexores</h1>
                    <p>Seguimiento de pacientes con lesiones en zonas I, II, III, IV y V</p>
                    <p><small>üî• <strong>Datos guardados en la nube con Firebase</strong></small></p>
                </div>
                
                <div class="access-buttons">
                    <button class="btn btn--primary" onclick="showSection('patientSection')">
                        Acceso Paciente
                    </button>
                    <button class="btn btn--secondary" onclick="showSection('doctorLogin')">
                        Acceso M√©dico
                    </button>
                </div>
            </div>
        </section>

        <!-- Login M√©dico -->
        <section id="doctorLogin" class="section">
            <div class="login-container">
                <div class="card">
                    <div class="card-header">
                        <h2>Acceso M√©dico</h2>
                        <p><small>üî• Los datos se sincronizan autom√°ticamente en la nube</small></p>
                    </div>
                    <div class="card-body">
                        <form id="doctorLoginForm">
                            <div class="form-group">
                                <label class="form-label">N√∫mero de C√©dula</label>
                                <input type="text" id="doctorId" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nombre Completo</label>
                                <input type="text" id="doctorName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contrase√±a</label>
                                <input type="password" id="doctorPassword" class="form-control" required>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn--primary">Ingresar</button>
                                <button type="button" class="btn btn--outline" onclick="showSection('accessScreen')">Volver</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Secci√≥n Paciente -->
        <section id="patientSection" class="section">
            <div class="section-header">
                <h2>Informaci√≥n para Pacientes</h2>
                <button class="btn btn--outline" onclick="showSection('accessScreen')">Volver</button>
            </div>
            
            <!-- Protocolos de Ejercicios -->
            <div class="card">
                <div class="card-header">
                    <h3>Protocolos de Ejercicios</h3>
                </div>
                <div class="card-body">
                    <div class="protocol-tabs">
                        <button class="tab-button active" onclick="showProtocol('KLEINERT')">KLEINERT</button>
                        <button class="tab-button" onclick="showProtocol('DURAN')">DURAN</button>
                        <button class="tab-button" onclick="showProtocol('ACTIVE_MOTION')">ACTIVE MOTION</button>
                    </div>
                    <div id="protocolContent" class="protocol-content">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Cuidados del Paciente -->
            <div class="card">
                <div class="card-header">
                    <h3>Cuidados del Paciente</h3>
                </div>
                <div class="card-body">
                    <div class="care-section">
                        <h4>Cuidados de F√©rula y Cicatriz</h4>
                        
                        <div class="care-subsection">
                            <h5>Cuidado de la F√©rula</h5>
                            <ul class="care-list">
                                <li>Mantener seca y limpia</li>
                                <li>No remover sin indicaci√≥n m√©dica</li>
                                <li>Revisar ajuste diariamente</li>
                                <li>Reportar dolor, hinchaz√≥n o cambios de color</li>
                                <li>No mojarse durante el ba√±o</li>
                            </ul>
                        </div>
                        
                        <div class="care-subsection">
                            <h5>Cuidado de la Cicatriz</h5>
                            <ul class="care-list">
                                <li>Mantener √°rea limpia y seca</li>
                                <li>Masaje cicatricial posterior a 3 semanas</li>
                                <li>Protecci√≥n solar durante 6 meses</li>
                                <li>Aplicar crema hidratante suave</li>
                                <li>Evitar exposici√≥n a productos qu√≠micos</li>
                            </ul>
                        </div>
                        
                        <div class="care-subsection">
                            <h5>Signos de Alerta</h5>
                            <ul class="care-list">
                                <li>Aumento del dolor o inflamaci√≥n</li>
                                <li>Enrojecimiento o calor en la herida</li>
                                <li>Secreci√≥n con mal olor</li>
                                <li>Fiebre mayor a 38¬∞C</li>
                                <li>P√©rdida s√∫bita de movimiento</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dashboard M√©dico -->
        <section id="dashboard" class="section">
            <div id="doctorInfo" class="doctor-info">
                <!-- Se llena din√°micamente -->
            </div>
            
            <header class="app-header">
                <h1>Sistema de Evaluaci√≥n - Tendones Flexores</h1>
                <p>Panel de Control M√©dico</p>
                <p><small>üî• <strong>Datos sincronizados en Firebase</strong> - Compartidos entre todos los usuarios</small></p>
            </header>

            <div class="dashboard-stats">
                <div class="card stat-card">
                    <div class="card-body">
                        <h3>Total Pacientes</h3>
                        <div class="stat-number" id="totalPacientes">0</div>
                    </div>
                </div>
                
                <div class="card stat-card">
                    <div class="card-body">
                        <h3>Controles Pendientes</h3>
                        <div class="stat-number" id="controlesPendientes">0</div>
                    </div>
                </div>
                
                <div class="card stat-card">
                    <div class="card-body">
                        <h3>Pacientes con Controles Incompletos</h3>
                        <div class="stat-number" id="pacientesIncompletos">0</div>
                    </div>
                </div>
            </div>

            <div class="search-section">
                <h3>B√∫squeda de Pacientes</h3>
                <div class="search-form">
                    <input type="text" id="searchInput" class="form-control" placeholder="Buscar por nombre o n√∫mero de documento">
                    <button class="btn btn--primary" onclick="searchPatients()">Buscar</button>
                </div>
                <div id="searchResults" class="search-results"></div>
            </div>

            <div class="action-buttons">
                <button class="btn btn--primary" onclick="showSection('nuevoPatient')">Nuevo Paciente</button>
                <button class="btn btn--secondary" onclick="showControlSelection()">Control de Seguimiento</button>
                <button class="btn btn--info" onclick="showClinicalHistories()">Historias Cl√≠nicas Completas</button>
                <button class="btn btn--success" onclick="showSection('editPatients')">Editar Pacientes</button>
                <button class="btn btn--outline" onclick="exportData()">Exportar Datos CSV</button>
                <button class="btn btn--outline" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>
        </section>

        <!-- Secci√≥n Nuevo Paciente -->
        <section id="nuevoPatient" class="section">
            <div class="section-header">
                <h2>Registro de Nuevo Paciente</h2>
                <nav class="breadcrumb">
                    <span onclick="showSection('dashboard')" class="breadcrumb-link">Dashboard</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-current">Nuevo Paciente</span>
                </nav>
                <button class="btn btn--outline" onclick="showSection('dashboard')">Volver al Dashboard</button>
            </div>

            <form id="newPatientForm" class="patient-form">
                <!-- Identificaci√≥n del Paciente -->
                <div class="card">
                    <div class="card-header">
                        <h3>Identificaci√≥n del Paciente</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Fecha de Ingreso</label>
                                <input type="date" id="admissionDate" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tiempo de Evoluci√≥n (Horas)</label>
                                <input type="number" id="evolutionTime" class="form-control" required>
                            </div>

                            <div class="form-group col-span-2">
                                <label class="form-label">Nombre Completo</label>
                                <input type="text" id="fullName" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tipo de Documento</label>
                                <select id="documentType" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="C√©dula de Ciudadan√≠a">C√©dula de Ciudadan√≠a</option>
                                    <option value="Tarjeta de Identidad">Tarjeta de Identidad</option>
                                    <option value="Pasaporte">Pasaporte</option>
                                    <option value="Registro Civil">Registro Civil</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">N√∫mero de Documento</label>
                                <input type="text" id="documentNumber" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Edad</label>
                                <input type="number" id="age" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Sexo</label>
                                <select id="sex" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="Masculino">Masculino</option>
                                    <option value="Femenino">Femenino</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Nivel Educativo</label>
                                <select id="educationLevel" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="Primaria">Primaria</option>
                                    <option value="Secundaria">Secundaria</option>
                                    <option value="T√©cnico">T√©cnico</option>
                                    <option value="Tecn√≥logo">Tecn√≥logo</option>
                                    <option value="Universitario">Universitario</option>
                                    <option value="Especializaci√≥n">Especializaci√≥n</option>
                                    <option value="Maestr√≠a">Maestr√≠a</option>
                                    <option value="Doctorado">Doctorado</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Ocupaci√≥n</label>
                                <input type="text" id="occupation" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Pa√≠s de Origen</label>
                                <input type="text" id="originCountry" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Ciudad de Nacimiento</label>
                                <input type="text" id="birthCity" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Direcci√≥n</label>
                                <input type="text" id="address" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Departamento</label>
                                <input type="text" id="department" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Ciudad de Residencia</label>
                                <input type="text" id="city" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tel√©fono</label>
                                <input type="tel" id="phone" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" id="email" class="form-control">
                            </div>

                            <div class="form-group">
                                <label class="form-label">EPS</label>
                                <input type="text" id="eps" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tipo de Afiliaci√≥n</label>
                                <select id="affiliationType" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="CONTRIBUTIVO">CONTRIBUTIVO</option>
                                    <option value="SUBSIDIADO">SUBSIDIADO</option>
                                    <option value="BENEFICIARIO">BENEFICIARIO</option>
                                    <option value="AFILIADO">AFILIADO</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Lateralidad</label>
                                <select id="laterality" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="Derecho">Derecho</option>
                                    <option value="Izquierdo">Izquierdo</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Estrato</label>
                                <select id="estrato" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Religi√≥n</label>
                                <input type="text" id="religion" class="form-control">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Acompa√±ante</label>
                                <input type="text" id="companionName" class="form-control">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Relaci√≥n Acompa√±ante</label>
                                <input type="text" id="companionRelation" class="form-control">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tel√©fono Acompa√±ante</label>
                                <input type="tel" id="companionPhone" class="form-control">
                            </div>

                            <div class="form-group col-span-2">
                                <label class="form-label">Comorbilidades Actuales</label>
                                <textarea id="comorbilidadesActuales" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Datos del Trauma -->
                <div class="card">
                    <div class="card-header">
                        <h3>Datos del Trauma</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Miembro Lesionado</label>
                                <select id="miembroLesionado" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="Izquierdo">Izquierdo</option>
                                    <option value="Derecho">Derecho</option>
                                </select>
                            </div>

                            <div class="form-group col-span-2">
                                <label class="form-label">Zonas Lesionadas</label>
                                <div class="checkbox-group">
                                    <label><input type="checkbox" id="zone1" value="I"> Zona I</label>
                                    <label><input type="checkbox" id="zone2" value="II"> Zona II</label>
                                    <label><input type="checkbox" id="zone3" value="III"> Zona III</label>
                                    <label><input type="checkbox" id="zone4" value="IV"> Zona IV</label>
                                    <label><input type="checkbox" id="zone5" value="V"> Zona V</label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Objeto</label>
                                <input type="text" id="object" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Etiolog√≠a</label>
                                <select id="etiology" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="CORTOPUNZANTE">CORTOPUNZANTE</option>
                                    <option value="CORTOCONTUNDENTE">CORTOCONTUNDENTE</option>
                                    <option value="APLASTAMIENTO">APLASTAMIENTO</option>
                                    <option value="EXPLOSIVO">EXPLOSIVO</option>
                                    <option value="CIZALLANTE">CIZALLANTE</option>
                                    <option value="COMBINADO">COMBINADO</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Mecanismo del Trauma</label>
                                <select id="traumaMechanism" class="form-control" required>
                                    <option value="">Seleccionar</option>
                                    <option value="ABIERTO">ABIERTO</option>
                                    <option value="CERRADO">CERRADO</option>
                                </select>
                            </div>

                            <div class="form-group col-span-2">
                                <label class="form-label">Descripci√≥n Prequir√∫rgica</label>
                                <textarea id="presurgicalDescription" class="form-control" rows="3"></textarea>
                            </div>

                            <div class="form-group col-span-2">
                                <label class="form-label">Tend√≥n Flexor Comprometido</label>
                                <div class="checkbox-group">
                                    <label><input type="checkbox" id="tendonfds" value="FDS"> FDS</label>
                                    <label><input type="checkbox" id="tendonfdp" value="FDP"> FDP</label>
                                    <label><input type="checkbox" id="tendonfpl" value="FPL"> FPL</label>
                                    <label><input type="checkbox" id="tendonfcu" value="FCU"> FCU</label>
                                    <label><input type="checkbox" id="tendonfcr" value="FCR"> FCR</label>
                                    <label><input type="checkbox" id="tendonpl" value="PL"> PL</label>
                                </div>
                            </div>

                            <div class="form-group col-span-2">
                                <label class="form-label">Descripci√≥n Tendones</label>
                                <textarea id="tendonDescription" class="form-control" rows="3"></textarea>
                            </div>

                            <div class="form-group col-span-2">
                                <label class="form-label">Lesiones Asociadas</label>
                                <div class="checkbox-group">
                                    <label><input type="checkbox" id="injurynervioso" value="NERVIOSO"> NERVIOSO</label>
                                    <label><input type="checkbox" id="injuryoseo" value="√ìSEO"> √ìSEO</label>
                                    <label><input type="checkbox" id="injuryvascular" value="VASCULAR"> VASCULAR</label>
                                    <label><input type="checkbox" id="injurymuscular" value="MUSCULAR"> MUSCULAR</label>
                                    <label><input type="checkbox" id="injuryligamentaria" value="LIGAMENTARIA"> LIGAMENTARIA</label>
                                    <label><input type="checkbox" id="injurycapsula" value="C√ÅPSULA ARTICULAR"> C√ÅPSULA ARTICULAR</label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Lesi√≥n Espec√≠fica</label>
                                <input type="text" id="specificAssociatedInjury" class="form-control">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tenorrafia (hilos)</label>
                                <input type="text" id="tenorrhaphyThreads" class="form-control">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tipo de Reparaci√≥n</label>
                                <select id="repairType" class="form-control">
                                    <option value="">Seleccionar</option>
                                    <option value="CENTRAL">CENTRAL</option>
                                    <option value="EPITENDINOSA">EPITENDINOSA</option>
                                    <option value="MIXTA">MIXTA</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">T√©cnica de Reparaci√≥n</label>
                                <input type="text" id="repairTechnique" class="form-control">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tenolisis</label>
                                <select id="tenolysis" class="form-control">
                                    <option value="">Seleccionar</option>
                                    <option value="S√≠">S√≠</option>
                                    <option value="No">No</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Fecha Quir√∫rgica</label>
                                <input type="date" id="surgeryDate" class="form-control" onchange="calculateDaysToSurgery()">
                            </div>

                            <div class="form-group">
                                <label class="form-label">D√≠as para Cirug√≠a</label>
                                <input type="number" id="daysToSurgery" class="form-control" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn--primary">Registrar Paciente</button>
                    <button type="button" class="btn btn--secondary" onclick="showSection('dashboard')">Cancelar</button>
                </div>
            </form>
        </section>

        <!-- Control de Seguimiento -->
        <section id="followUpControl" class="section">
            <div class="section-header">
                <h2>Control de Seguimiento</h2>
                <nav class="breadcrumb">
                    <span onclick="showSection('dashboard')" class="breadcrumb-link">Dashboard</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-current">Control de Seguimiento</span>
                </nav>
                <button class="btn btn--outline" onclick="showSection('dashboard')">Volver al Dashboard</button>
            </div>

            <!-- Selecci√≥n de Paciente -->
            <div id="patientSelection">
                <div class="card">
                    <div class="card-header">
                        <h3>Buscar Paciente</h3>
                    </div>
                    <div class="card-body">
                        <div class="search-form">
                            <input type="text" id="followUpSearch" class="form-control" placeholder="Buscar paciente por nombre o documento">
                            <button class="btn btn--primary" onclick="searchPatientsForFollowUp()">Buscar</button>
                        </div>
                        <div id="followUpSearchResults" class="search-results"></div>
                    </div>
                </div>
            </div>

            <!-- Formulario de Control -->
            <div id="followUpForm" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h3>Control de Seguimiento - <span id="selectedPatientName"></span></h3>
                    </div>
                    <div class="card-body">
                        <form id="followUpForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Semana de Control</label>
                                    <select id="followUpWeek" class="form-control" required>
                                        <option value="">Seleccionar semana</option>
                                        <option value="1">Semana 1</option>
                                        <option value="3">Semana 3</option>
                                        <option value="6">Semana 6</option>
                                        <option value="12">Semana 12</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Protocolo Utilizado</label>
                                    <select id="protocolUsed" class="form-control">
                                        <option value="">Seleccionar</option>
                                        <option value="KLEINERT">KLEINERT</option>
                                        <option value="DURAN">DURAN</option>
                                        <option value="ACTIVE_MOTION">ACTIVE MOTION</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Terapias Completas</label>
                                    <select id="completeTherapies" class="form-control" onchange="toggleIncompleteReason()">
                                        <option value="">Seleccionar</option>
                                        <option value="true">S√≠</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>

                                <div class="form-group" id="incompleteReasonGroup" style="display: none;">
                                    <label class="form-label">Raz√≥n de Incompletitud</label>
                                    <textarea id="incompleteReason" class="form-control" rows="2"></textarea>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Complicaciones</label>
                                    <textarea id="complicaciones" class="form-control" rows="2"></textarea>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Reintervenci√≥n Quir√∫rgica</label>
                                    <input type="text" id="reintervencionQuirurgica" class="form-control">
                                </div>
                            </div>

                            <!-- Goniometr√≠a -->
                            <div class="form-section">
                                <h4>Mediciones Goniom√©tricas</h4>
                                <div id="goniometryMeasurements" class="goniometry-grid">
                                    <!-- Se genera din√°micamente -->
                                </div>
                            </div>

                            <!-- Resultados TAM -->
                            <div class="form-section">
                                <h4>Resultados TAM por Dedo</h4>
                                <div id="tamByFingerResults" class="tam-results">
                                    <!-- Se genera din√°micamente -->
                                </div>
                            </div>

                            <!-- Clasificaci√≥n Strickland -->
                            <div class="form-section">
                                <h4>Clasificaci√≥n Strickland</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Resultado Strickland (%)</label>
                                        <input type="number" id="stricklandResult" class="form-control" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Clasificaci√≥n</label>
                                        <input type="text" id="stricklandClassification" class="form-control" readonly>
                                    </div>
                                </div>
                            </div>

                            <!-- QuickDASH -->
                            <div class="form-section">
                                <h4>Evaluaci√≥n QuickDASH</h4>
                                <div id="quickDashQuestions">
                                    <!-- Se genera din√°micamente -->
                                </div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Puntuaci√≥n QuickDASH</label>
                                        <input type="number" id="quickDashScore" class="form-control" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Grado de Discapacidad</label>
                                        <input type="text" id="dashDisabilityGrade" class="form-control" readonly>
                                    </div>
                                </div>
                            </div>

                            <!-- Retorno Laboral -->
                            <div class="form-section">
                                <h4>Retorno Laboral</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Retorno a Ocupaci√≥n Previa</label>
                                        <select id="returnToPreviousOccupation" class="form-control" onchange="toggleReturnTimeField()">
                                            <option value="">Seleccionar</option>
                                            <option value="true">S√≠</option>
                                            <option value="false">No</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Cambio de Ocupaci√≥n</label>
                                        <input type="text" id="occupationChange" class="form-control">
                                    </div>

                                    <div class="form-group" id="returnTimeGroup" style="display: none;">
                                        <label class="form-label">Tiempo de Retorno (meses)</label>
                                        <input type="number" id="returnTimeMonths" class="form-control">
                                    </div>
                                </div>
                            </div>

                            <!-- Mediciones Adicionales -->
                            <div class="form-section">
                                <h4>Mediciones Adicionales</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Dinam√≥metro Izquierdo (kg)</label>
                                        <input type="number" id="dynamometerLeft" class="form-control" step="0.1" onchange="calculateDynamometerDifference()">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Dinam√≥metro Derecho (kg)</label>
                                        <input type="number" id="dynamometerRight" class="form-control" step="0.1" onchange="calculateDynamometerDifference()">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Diferencia (kg)</label>
                                        <input type="number" id="dynamometerDifference" class="form-control" step="0.1" readonly>
                                    </div>
                                </div>

                                <!-- Distancia U√±a-Palma -->
                                <h5>Distancia U√±a-Palma (mm)</h5>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Dedo 2 (√çndice)</label>
                                        <input type="number" id="nailPalmDistance2" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Dedo 3 (Medio)</label>
                                        <input type="number" id="nailPalmDistance3" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Dedo 4 (Anular)</label>
                                        <input type="number" id="nailPalmDistance4" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Dedo 5 (Me√±ique)</label>
                                        <input type="number" id="nailPalmDistance5" class="form-control">
                                    </div>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn--primary">Guardar Control</button>
                                <button type="button" class="btn btn--secondary" onclick="cancelFollowUp()">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Secci√≥n Editar Pacientes -->
        <section id="editPatients" class="section">
            <div class="section-header">
                <h2>Editar Informaci√≥n de Pacientes</h2>
                <button class="btn btn--outline" onclick="showSection('dashboard')">Volver al Dashboard</button>
            </div>

            <div class="search-section">
                <div class="search-form">
                    <input type="text" id="editPatientSearch" class="form-control" placeholder="Buscar paciente por nombre o documento para editar">
                    <button class="btn btn--primary" onclick="searchPatientsForEdit()">Buscar</button>
                </div>
            </div>

            <div id="editPatientsList" class="edit-patients-list">
                <!-- Se llena din√°micamente -->
            </div>
        </section>

        <!-- Historias Cl√≠nicas Completas -->
        <section id="clinicalHistories" class="section">
            <div class="section-header">
                <h2>Historias Cl√≠nicas Completas</h2>
                <nav class="breadcrumb">
                    <span onclick="showSection('dashboard')" class="breadcrumb-link">Dashboard</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-current">Historias Cl√≠nicas</span>
                </nav>
                <button class="btn btn--outline" onclick="showSection('dashboard')">Volver al Dashboard</button>
            </div>

            <div class="search-section">
                <div class="search-form">
                    <input type="text" id="clinicalHistorySearch" class="form-control" placeholder="Buscar paciente por nombre o documento">
                    <button class="btn btn--primary" onclick="searchClinicalHistories()">Buscar</button>
                </div>
            </div>

            <div id="clinicalHistoriesList" class="clinical-histories-list">
                <!-- Se llena din√°micamente -->
            </div>
        </section>

        <!-- Vista Individual de Historia Cl√≠nica -->
        <section id="individualClinicalHistory" class="section">
            <div class="section-header">
                <h2 id="clinicalHistoryPatientName">Historia Cl√≠nica</h2>
                <nav class="breadcrumb">
                    <span onclick="showSection('dashboard')" class="breadcrumb-link">Dashboard</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span onclick="showSection('clinicalHistories')" class="breadcrumb-link">Historias Cl√≠nicas</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-current">Vista Individual</span>
                </nav>
                <div class="header-actions">
                    <button class="btn btn--primary" onclick="copyCompleteHistory()">Copiar Historia Cl√≠nica Completa</button>
                    <button class="btn btn--outline" onclick="showSection('clinicalHistories')">Volver a Lista</button>
                </div>
            </div>

            <div id="individualHistoryContent" class="individual-history-content">
                <!-- Se llena din√°micamente -->
            </div>
        </section>

        <!-- Exercise Timer Modal -->
        <div id="exerciseTimerModal" class="modal hidden">
            <div class="modal-content exercise-modal">
                <div class="modal-header">
                    <h3 id="exerciseTitle">Ejercicio</h3>
                    <button class="btn btn--outline btn--sm" onclick="closeExerciseModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <div id="exerciseDescription" class="exercise-description"></div>
                    <div class="timer-display">
                        <div id="timerCircle" class="timer-circle">
                            <div id="timerText" class="timer-text">00:00</div>
                        </div>
                    </div>
                    <div class="timer-controls">
                        <button id="timerStartBtn" class="btn btn--primary" onclick="startTimer()">Iniciar</button>
                        <button id="timerPauseBtn" class="btn btn--secondary hidden" onclick="pauseTimer()">Pausar</button>
                        <button id="timerResetBtn" class="btn btn--outline" onclick="resetTimer()">Reiniciar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="modal hidden">
            <div class="modal-content edit-modal">
                <div class="modal-header">
                    <h3 id="editModalTitle">Editar Informaci√≥n</h3>
                    <button class="btn btn--outline btn--sm" onclick="closeEditModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <div id="editFormContent"></div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn--primary">Guardar Cambios</button>
                            <button type="button" class="btn btn--secondary" onclick="closeEditModal()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="spinner hidden">
            <div class="spinner-circle"></div>
        </div>
    </div>

    <!-- JavaScript Firebase integrado DEBE ir al final -->
    <script src="app-firebase-integrado.js"></script>
    
    <script>
        // Firebase Status Management
        function updateFirebaseStatus(connected, message = '') {
            const status = document.getElementById('firebaseStatus');
            if (connected) {
                status.textContent = 'üî• Conectado a Firebase';
                status.className = 'firebase-status';
            } else {
                status.textContent = '‚ùå Error Firebase: ' + message;
                status.className = 'firebase-status error';
            }
        }
        
        // Firebase Connection Test
        window.addEventListener('load', () => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            setTimeout(() => {
                try {
                    if (typeof firebase !== 'undefined' && typeof db !== 'undefined') {
                        // Test Firebase connection
                        db.collection('patients').limit(1).get()
                            .then(() => {
                                updateFirebaseStatus(true);
                                console.log('‚úÖ Firebase conectado y funcionando correctamente');
                            })
                            .catch((error) => {
                                updateFirebaseStatus(false, 'Error de conexi√≥n');
                                console.error('‚ùå Error conectando a Firebase:', error);
                            });
                    } else {
                        updateFirebaseStatus(false, 'SDK no cargado');
                        console.error('‚ùå Firebase no est√° definido');
                    }
                } catch (error) {
                    updateFirebaseStatus(false, error.message);
                    console.error('‚ùå Error inicializando Firebase:', error);
                }
                
                // Hide loading overlay
                loadingOverlay.classList.add('hidden');
            }, 1000);
        });
        
        // Global error handler
        window.addEventListener('error', (event) => {
            if (event.message.includes('firebase')) {
                updateFirebaseStatus(false, 'Error en tiempo de ejecuci√≥n');
            }
        });
    </script>
</body>
</html>